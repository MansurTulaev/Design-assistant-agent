FROM python:3.12-slim

WORKDIR /app

# Копируем зависимости
COPY pyproject.toml .
COPY requirements-dev.txt .

# Устанавливаем зависимости
RUN pip install --no-cache-dir -e . && \
    pip install --no-cache-dir -r requirements-dev.txt

# Копируем исходный код
COPY src/ ./src/
COPY tests/ ./tests/
COPY agent-config/ ./agent-config/

# Создаем пользователя
RUN useradd -m -u 1000 testuser && chown -R testuser:testuser /app
USER testuser

# Точка входа для тестов
CMD ["pytest", "tests/", "-v", "--cov=src"]